const axios =  require('axios').default

const fazerBusca = async (req, res) => {
    const {genero} = req.params;

    try {
        const {data} = await axios.get(           
           `http://openlibrary.org/subjects/${genero}.json?limit=200`
        );

        const alea = Math.floor(Math.random() * 100);
        const work = data.works[alea];

        const livro = await axios.get(`https://openlibrary.org/works/${work.cover_edition_key}`).then(({data}) => {
            return data
        })

        const result = {
            titulo: work.title,
            autor: work.authors[0].name,
            primeira_publicacao: livro.publish_date,
            numero_paginas: livro.number_of_pages,
            descricao: livro.description || null,
            capa: {
                id_capa: work.cover_id,
                key_cover: work.cover_edition_key
            }
        }

        return res.status(200).json(result);
    } catch (error) {      
        return res.status(400).json(error.message);
    }
}

module.exports = fazerBusca;